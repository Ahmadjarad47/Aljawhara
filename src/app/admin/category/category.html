<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-base-content">{{ t('categoryManagement') }}</h1>
            <p class="text-base-content/70 mt-2">{{ t('manageJobCategories') }}</p>
        </div>
        <div class="flex gap-2">
            @if (selectedCategories().length > 0) {
                <button 
                    (click)="deleteSelected()" 
                    [disabled]="isLoading()"
                    class="btn btn-error btn-sm">
                    @if (isLoading()) {
                        <span class="loading loading-spinner loading-xs"></span>
                    } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    }
                    {{ t('deleteSelected') }} ({{selectedCategories().length}})
                </button>
            }
            <button (click)="showAddModal.set(true)" [disabled]="isLoading()" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                {{ t('addCategory') }}
            </button>
        </div>
    </div>


    <!-- Search and Filters -->
    <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
        <div class="card-body p-4">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search Input -->
                <div class="flex-1">
                    <div class="form-control">
                        <div class="input-group">
                            <input 
                                type="text" 
                                [placeholder]="t('searchCategories')" 
                                class="input input-bordered flex-1" 
                                [ngModel]="searchTerm()"
                                (ngModelChange)="searchTerm.set($event)"
                                (keyup.enter)="onSearch()" />
                            <button (click)="onSearch()" [disabled]="isLoading()" class="btn btn-square">
                                @if (isLoading()) {
                                    <span class="loading loading-spinner loading-sm"></span>
                                } @else {
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                }
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="form-control">
                    <select 
                        class="select select-bordered" 
                        [ngModel]="statusFilter()"
                        (ngModelChange)="statusFilter.set($event); onStatusFilterChange($event)">
                        <option [value]="null">{{ t('allStatus') }}</option>
                        <option [value]="true">{{ t('active') }}</option>
                        <option [value]="false">{{ t('inactive') }}</option>
                    </select>
                </div>

                <!-- Page Size -->
                <div class="form-control">
                    <select 
                        class="select select-bordered" 
                        [ngModel]="pageSize()"
                        (ngModelChange)="pageSize.set($event); onPageSizeChange($event)">
                        <option [value]="10">10 {{ t('perPage') }}</option>
                        <option [value]="20">20 {{ t('perPage') }}</option>
                        <option [value]="50">50 {{ t('perPage') }}</option>
                        <option [value]="100">100 {{ t('perPage') }}</option>
                    </select>
                </div>

                <!-- Clear Filters -->
                <button (click)="clearFilters()" [disabled]="isLoading()" class="btn btn-outline">
                    {{ t('clearFilters') }}
                </button>
            </div>
        </div>
    </div>

    <!-- Categories Table -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body p-0">
            @if (isLoading()) {
                <div class="flex justify-center items-center py-12">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
            } @else {
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>
                                    <label>
                                        <input 
                                            type="checkbox" 
                                            class="checkbox checkbox-sm" 
                                            [checked]="selectedCategories().length === getCategoriesLength() && getCategoriesLength() > 0"
                                            [disabled]="isLoading()"
                                            (change)="toggleSelectAll()" />
                                    </label>
                                </th>
                                <th>{{ t('categoryNameEN') }}</th>
                                <th>{{ t('categoryNameAR') }}</th>
                                <th>{{ t('descriptionEN') }}</th>
                                <th>{{ t('descriptionAR') }}</th>
                                <th>{{ t('productCount') }}</th>
                                <th>{{ t('status') }}</th>
                                <th>{{ t('actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (category of categories$| async; track $index) {

                                <tr>
                                <th>
                                    <label>
                                        <input 
                                            type="checkbox" 
                                            class="checkbox checkbox-sm" 
                                            [checked]="selectedCategories().includes(category.id)"
                                            [disabled]="isLoading()"
                                            (change)="toggleCategorySelection(category.id)" />
                                    </label>
                                </th>
                                <td>
                                    <div class="font-semibold">{{category.name}}</div>
                                </td>
                                <td>
                                    <div class="font-semibold" dir="rtl">{{category.nameAr}}</div>
                                </td>
                                <td>
                                    <div class="text-sm text-base-content/70 max-w-xs truncate">{{category.description}}</div>
                                </td>
                                <td>
                                    <div class="text-sm text-base-content/70 max-w-xs truncate" dir="rtl">{{category.descriptionAr}}</div>
                                </td>
                                <td>
                                    <div class="badge badge-outline">{{category.productCount}} {{ t('products') }}</div>
                                </td>
                                <td>
                                    <div class="badge" [class.badge-success]="category.isActive" [class.badge-error]="!category.isActive">
                                        {{category.isActive ? t('active') : t('inactive')}}
                                    </div>
                                </td>
                                <th>
                                    <div class="flex gap-1">
                                        <button 
                                            (click)="toggleCategoryStatus(category.id)"
                                            [disabled]="isLoading()"
                                            class="btn btn-ghost btn-xs"
                                            [class.btn-success]="!category.isActive"
                                            [class.btn-error]="category.isActive">
                                            @if (isLoading()) {
                                                <span class="loading loading-spinner loading-xs"></span>
                                            } @else {
                                                {{category.isActive ? t('deactivate') : t('activate')}}
                                            }
                                        </button>
                                        <button 
                                            (click)="editCategoryStart(category)"
                                            [disabled]="isLoading()"
                                            class="btn btn-ghost btn-xs">
                                            {{ t('edit') }}
                                        </button>
                                    </div>
                                </th>
                            </tr>
                            }
                            @if (getCategoriesLength() === 0 && !isLoading()) {
                                <tr>
                                    <td colspan="8" class="text-center py-8 text-base-content/50">
                                        {{ t('noCategoriesFound') }}
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Pagination -->
    @if (getTotalPages() > 1) {
        <div class="flex justify-center items-center mt-6">
            <div class="join">
                <!-- Previous Button -->
                <button 
                    (click)="onPageChange(getCurrentPage() - 1)" 
                    [disabled]="getCurrentPage() === 1 || isLoading()"
                    class="join-item btn">
                    «
                </button>

                <!-- Page Numbers -->
                @for (page of pageNumbers$ | async; track page) {
                    @if (page === '...') {
                        <button class="join-item btn btn-disabled">...</button>
                    } @else {
                        <button 
                            (click)="onPageChange(+page)" 
                            [disabled]="isLoading()"
                            [class.btn-active]="getCurrentPage() === page"
                            class="join-item btn">
                            {{page}}
                        </button>
                    }
                }

                <!-- Next Button -->
                <button 
                    (click)="onPageChange(getCurrentPage() + 1)" 
                    [disabled]="getCurrentPage() === getTotalPages() || isLoading()"
                    class="join-item btn">
                    »
                </button>
            </div>
        </div>

        <!-- Pagination Info -->
        <div class="text-center mt-4 text-sm text-base-content/70">
            @if (pagination$ | async; as pagination) {
                {{ t('showing') }} {{((pagination.currentPage - 1) * pagination.pageSize) + 1}} {{ t('to') }} {{Math.min(pagination.currentPage * pagination.pageSize, pagination.totalCount)}} {{ t('of') }} {{pagination.totalCount}} {{ t('categories') }}
            }
        </div>
    }

    <!-- Add Category Modal -->
    @if (showAddModal()) {
        <div class="modal modal-open">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">{{ t('addNewCategory') }}</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- English Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('categoryNameEN') }}</span>
                    </label>
                    <input 
                        type="text" 
                        [placeholder]="t('enterCategoryNameEN')" 
                        class="input input-bordered w-full" 
                        [(ngModel)]="newCategory.name" />
                </div>

                <!-- Arabic Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('categoryNameAR') }}</span>
                    </label>
                    <input 
                        type="text" 
                        [placeholder]="t('enterCategoryNameAR')" 
                        class="input input-bordered w-full" 
                        dir="rtl"
                        [(ngModel)]="newCategory.nameAr" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <!-- English Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('descriptionEN') }}</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        [placeholder]="t('enterDescriptionEN')"
                        [(ngModel)]="newCategory.description"></textarea>
                </div>

                <!-- Arabic Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('descriptionAR') }}</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        [placeholder]="t('enterDescriptionAR')"
                        dir="rtl"
                        [(ngModel)]="newCategory.descriptionAr"></textarea>
                </div>
            </div>

            <div class="modal-action">
                <button (click)="closeModals()" [disabled]="isLoading()" class="btn btn-ghost">{{ t('cancel') }}</button>
                <button (click)="addCategory()" [disabled]="isLoading()" class="btn btn-primary">
                    @if (isLoading()) {
                        <span class="loading loading-spinner loading-sm"></span>
                    }
                    {{ t('addCategory') }}
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Edit Category Modal -->
    @if (showEditModal()) {
        <div class="modal modal-open">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">{{ t('editCategory') }}</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- English Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('categoryNameEN') }}</span>
                    </label>
                    <input 
                        type="text" 
                        [placeholder]="t('enterCategoryNameEN')" 
                        class="input input-bordered w-full" 
                        [(ngModel)]="editCategory.name" />
                </div>

                <!-- Arabic Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('categoryNameAR') }}</span>
                    </label>
                    <input 
                        type="text" 
                        [placeholder]="t('enterCategoryNameAR')" 
                        class="input input-bordered w-full" 
                        dir="rtl"
                        [(ngModel)]="editCategory.nameAr" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <!-- English Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('descriptionEN') }}</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        [placeholder]="t('enterDescriptionEN')"
                        [(ngModel)]="editCategory.description"></textarea>
                </div>

                <!-- Arabic Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">{{ t('descriptionAR') }}</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        [placeholder]="t('enterDescriptionAR')"
                        dir="rtl"
                        [(ngModel)]="editCategory.descriptionAr"></textarea>
                </div>
            </div>

            <div class="modal-action">
                <button (click)="closeModals()" [disabled]="isLoading()" class="btn btn-ghost">{{ t('cancel') }}</button>
                <button (click)="updateCategory()" [disabled]="isLoading()" class="btn btn-primary">
                    @if (isLoading()) {
                        <span class="loading loading-spinner loading-sm"></span>
                    }
                    {{ t('updateCategory') }}
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Toast Component -->
    <app-toast 
        [toasts]="toasts" 
        (close)="onToastClose($event)">
    </app-toast>
</div>

