<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-base-content">Sub-Category Management</h1>
            <p class="text-base-content/70 mt-2">Manage sub-categories and their settings</p>
        </div>
        <div class="flex gap-2">
            @if (selectedSubCategories().length > 0) {
                <button 
                    (click)="deleteSelected()" 
                    [disabled]="isLoading()"
                    class="btn btn-error btn-sm">
                    @if (isLoading()) {
                        <span class="loading loading-spinner loading-xs"></span>
                    } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    }
                    Delete Selected ({{selectedSubCategories().length}})
                </button>
            }
            <button (click)="showAddModal.set(true)" [disabled]="isLoading()" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Sub-Category
            </button>
        </div>
    </div>


    <!-- Search and Filters -->
    <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
        <div class="card-body p-4">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Search Input -->
                <div class="flex-1">
                    <div class="form-control">
                        <div class="input-group">
                            <input 
                                type="text" 
                                placeholder="Search sub-categories..." 
                                class="input input-bordered flex-1" 
                                [ngModel]="searchTerm()"
                                (ngModelChange)="searchTerm.set($event)"
                                (keyup.enter)="onSearch()" />
                            <button (click)="onSearch()" [disabled]="isLoading()" class="btn btn-square">
                                @if (isLoading()) {
                                    <span class="loading loading-spinner loading-sm"></span>
                                } @else {
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                }
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="form-control">
                    <select 
                        class="select select-bordered" 
                        [ngModel]="categoryFilter()"
                        (ngModelChange)="categoryFilter.set($event); onCategoryFilterChange($event)">
                        <option [value]="null">All Categories</option>
                        @for (category of categories$ | async; track category.id) {
                            <option [value]="category.id">{{category.name}}</option>
                        }
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="form-control">
                    <select 
                        class="select select-bordered" 
                        [ngModel]="statusFilter()"
                        (ngModelChange)="statusFilter.set($event); onStatusFilterChange($event)">
                        <option [value]="null">All Status</option>
                        <option [value]="true">Active</option>
                        <option [value]="false">Inactive</option>
                    </select>
                </div>

                <!-- Page Size -->
                <div class="form-control">
                    <select 
                        class="select select-bordered" 
                        [ngModel]="pageSize()"
                        (ngModelChange)="pageSize.set($event); onPageSizeChange($event)">
                        <option [value]="10">10 per page</option>
                        <option [value]="20">20 per page</option>
                        <option [value]="50">50 per page</option>
                        <option [value]="100">100 per page</option>
                    </select>
                </div>

                <!-- Clear Filters -->
                <button (click)="clearFilters()" [disabled]="isLoading()" class="btn btn-outline">
                    Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Sub-Categories Table -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body p-0">
            @if (isLoading()) {
                <div class="flex justify-center items-center py-12">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
            } @else {
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>
                                    <label>
                                    <input 
                                        type="checkbox" 
                                        class="checkbox checkbox-sm" 
                                        [checked]="selectedSubCategories().length === getSubCategoriesLength() && getSubCategoriesLength() > 0"
                                        [disabled]="isLoading()"
                                        (change)="toggleSelectAll()" />
                                    </label>
                                </th>
                                <th>Sub-Category Name (EN)</th>
                                <th>Sub-Category Name (AR)</th>
                                <th>Description (EN)</th>
                                <th>Description (AR)</th>
                                <th>Category</th>
                                <th>Product Count</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (subCategory of subCategories$| async; track $index) {
                                <tr>
                                <th>
                                    <label>
                                        <input 
                                            type="checkbox" 
                                            class="checkbox checkbox-sm" 
                                            [checked]="selectedSubCategories().includes(subCategory.id)"
                                            [disabled]="isLoading()"
                                            (change)="toggleSubCategorySelection(subCategory.id)" />
                                    </label>
                                </th>
                                <td>
                                    <div class="font-semibold">{{subCategory.name}}</div>
                                </td>
                                <td>
                                    <div class="font-semibold" dir="rtl">{{subCategory.nameAr}}</div>
                                </td>
                                <td>
                                    <div class="text-sm text-base-content/70 max-w-xs truncate">{{subCategory.description}}</div>
                                </td>
                                <td>
                                    <div class="text-sm text-base-content/70 max-w-xs truncate" dir="rtl">{{subCategory.descriptionAr}}</div>
                                </td>
                                <td>
                                    <div class="badge badge-outline">{{subCategory.categoryName}}</div>
                                </td>
                                <td>
                                    <div class="badge badge-outline">{{subCategory.productCount}} products</div>
                                </td>
                                <td>
                                    <div class="badge" [class.badge-success]="subCategory.isActive" [class.badge-error]="!subCategory.isActive">
                                        {{subCategory.isActive ? 'Active' : 'Inactive'}}
                                    </div>
                                </td>
                                <th>
                                    <div class="flex gap-1">
                                        <button 
                                            (click)="toggleSubCategoryStatus(subCategory.id)"
                                            [disabled]="isLoading()"
                                            class="btn btn-ghost btn-xs"
                                            [class.btn-success]="!subCategory.isActive"
                                            [class.btn-error]="subCategory.isActive">
                                            @if (isLoading()) {
                                                <span class="loading loading-spinner loading-xs"></span>
                                            } @else {
                                                {{subCategory.isActive ? 'Deactivate' : 'Activate'}}
                                            }
                                        </button>
                                        <button 
                                            (click)="editSubCategoryStart(subCategory)"
                                            [disabled]="isLoading()"
                                            class="btn btn-ghost btn-xs">
                                            Edit
                                        </button>
                                    </div>
                                </th>
                            </tr>
                            }
                            @if (getSubCategoriesLength() === 0 && !isLoading()) {
                                <tr>
                                    <td colspan="9" class="text-center py-8 text-base-content/50">
                                        No sub-categories found
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Pagination -->
    @if (getTotalPages() > 1) {
        <div class="flex justify-center items-center mt-6">
            <div class="join">
                <!-- Previous Button -->
                <button 
                    (click)="onPageChange(getCurrentPage() - 1)" 
                    [disabled]="getCurrentPage() === 1 || isLoading()"
                    class="join-item btn">
                    «
                </button>

                <!-- Page Numbers -->
                @for (page of pageNumbers$ | async; track page) {
                    @if (page === '...') {
                        <button class="join-item btn btn-disabled">...</button>
                    } @else {
                        <button 
                            (click)="onPageChange(+page)" 
                            [disabled]="isLoading()"
                            [class.btn-active]="getCurrentPage() === page"
                            class="join-item btn">
                            {{page}}
                        </button>
                    }
                }

                <!-- Next Button -->
                <button 
                    (click)="onPageChange(getCurrentPage() + 1)" 
                    [disabled]="getCurrentPage() === getTotalPages() || isLoading()"
                    class="join-item btn">
                    »
                </button>
            </div>
        </div>

        <!-- Pagination Info -->
        <div class="text-center mt-4 text-sm text-base-content/70">
            @if (pagination$ | async; as pagination) {
                Showing {{((pagination.currentPage - 1) * pagination.pageSize) + 1}} to {{Math.min(pagination.currentPage * pagination.pageSize, pagination.totalCount)}} of {{pagination.totalCount}} sub-categories
            }
        </div>
    }

    <!-- Add Sub-Category Modal -->
    @if (showAddModal()) {
        <div class="modal modal-open">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">Add New Sub-Category</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- English Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Sub-Category Name (English)</span>
                    </label>
                    <input 
                        type="text" 
                        placeholder="Enter sub-category name in English" 
                        class="input input-bordered w-full" 
                        [(ngModel)]="newSubCategory.name" />
                </div>

                <!-- Arabic Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Sub-Category Name (Arabic)</span>
                    </label>
                    <input 
                        type="text" 
                        placeholder="أدخل اسم الفئة الفرعية بالعربية" 
                        class="input input-bordered w-full" 
                        dir="rtl"
                        [(ngModel)]="newSubCategory.nameAr" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <!-- English Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Description (English)</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        placeholder="Enter sub-category description in English"
                        [(ngModel)]="newSubCategory.description"></textarea>
                </div>

                <!-- Arabic Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Description (Arabic)</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        placeholder="أدخل وصف الفئة الفرعية بالعربية"
                        dir="rtl"
                        [(ngModel)]="newSubCategory.descriptionAr"></textarea>
                </div>
            </div>

            <!-- Category Selection -->
            <div class="form-control w-full mt-4">
                <label class="label">
                    <span class="label-text">Parent Category</span>
                </label>
                <select 
                    class="select select-bordered w-full" 
                    [(ngModel)]="newSubCategory.categoryId">
                    <option [value]="0">Select a category</option>
                    @for (category of categories$ | async; track category.id) {
                        <option [value]="category.id">{{category.name}}</option>
                    }
                </select>
            </div>

            <div class="modal-action">
                <button (click)="closeModals()" [disabled]="isLoading()" class="btn btn-ghost">Cancel</button>
                <button (click)="addSubCategory()" [disabled]="isLoading()" class="btn btn-primary">
                    @if (isLoading()) {
                        <span class="loading loading-spinner loading-sm"></span>
                    }
                    Add Sub-Category
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Edit Sub-Category Modal -->
    @if (showEditModal()) {
        <div class="modal modal-open">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">Edit Sub-Category</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- English Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Sub-Category Name (English)</span>
                    </label>
                    <input 
                        type="text" 
                        placeholder="Enter sub-category name in English" 
                        class="input input-bordered w-full" 
                        [(ngModel)]="editSubCategory.name" />
                </div>

                <!-- Arabic Name -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Sub-Category Name (Arabic)</span>
                    </label>
                    <input 
                        type="text" 
                        placeholder="أدخل اسم الفئة الفرعية بالعربية" 
                        class="input input-bordered w-full" 
                        dir="rtl"
                        [(ngModel)]="editSubCategory.nameAr" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <!-- English Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Description (English)</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        placeholder="Enter sub-category description in English"
                        [(ngModel)]="editSubCategory.description"></textarea>
                </div>

                <!-- Arabic Description -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Description (Arabic)</span>
                    </label>
                    <textarea 
                        class="textarea textarea-bordered h-24" 
                        placeholder="أدخل وصف الفئة الفرعية بالعربية"
                        dir="rtl"
                        [(ngModel)]="editSubCategory.descriptionAr"></textarea>
                </div>
            </div>

            <!-- Category Selection -->
            <div class="form-control w-full mt-4">
                <label class="label">
                    <span class="label-text">Parent Category</span>
                </label>
                <select 
                    class="select select-bordered w-full" 
                    [(ngModel)]="editSubCategory.categoryId">
                    <option [value]="0">Select a category</option>
                    @for (category of categories$ | async; track category.id) {
                        <option [value]="category.id">{{category.name}}</option>
                    }
                </select>
            </div>

            <div class="modal-action">
                <button (click)="closeModals()" [disabled]="isLoading()" class="btn btn-ghost">Cancel</button>
                <button (click)="updateSubCategory()" [disabled]="isLoading()" class="btn btn-primary">
                    @if (isLoading()) {
                        <span class="loading loading-spinner loading-sm"></span>
                    }
                    Update Sub-Category
                </button>
            </div>
        </div>
    </div>
    }
</div>
