<div class="p-6">
  <div class="mb-6">
    <h2 class="text-2xl font-semibold">{{t('accountSettings')}}</h2>
    <p class="text-base-content/70">{{t('manageProfile')}}</p>
  </div>

  <div role="tablist" class="tabs tabs-boxed mb-4">
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'profile'" (click)="activeTab.set('profile')">{{t('profile')}}</a>
    <a role="tab" class="tab" [class.tab-active]="activeTab() === 'addresses'" (click)="activeTab.set('addresses')">{{t('addresses')}}</a>
  </div>

  @if (activeTab() === 'profile') {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
          <h3 class="card-title">{{t('userInfo')}}</h3>
          @if (isLoadingUser()) {
            <span class="loading loading-spinner"></span>
          } @else {
            @if (currentUser(); as user) {
              <div class="space-y-2">
                <div><span class="font-medium">{{t('username')}}:</span> {{user.username}}</div>
                <div><span class="font-medium">{{t('email')}}:</span> {{user.email}}</div>
                <div><span class="font-medium">{{t('phone')}}:</span> {{user.phoneNumber}}</div>
                <div><span class="font-medium">{{t('created')}}:</span> {{user.createdAt | date:'medium'}}</div>
              </div>
            }
          }
        </div>
      </div>

      <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
          <h3 class="card-title">{{t('updateUsername')}}</h3>
          <div class="form-control">
            <label class="label"><span class="label-text">{{t('username')}}</span></label>
            <input class="input input-bordered" type="text" [(ngModel)]="updateUsernameModel.username" />
          </div>
          <div class="card-actions justify-end mt-3">
            <button class="btn btn-primary" (click)="onUpdateUsername()">{{t('save')}}</button>
          </div>
        </div>
      </div>

      <div class="card bg-base-100 shadow-sm border border-base-300 lg:col-span-2">
        <div class="card-body">
          <h3 class="card-title">{{t('updatePhoneNumber')}}</h3>
          <div class="form-control">
            <label class="label"><span class="label-text">{{t('phoneNumber')}}</span></label>
            <input class="input input-bordered" type="tel" [(ngModel)]="updatePhoneModel.phoneNumber" />
          </div>
          <div class="card-actions justify-end mt-3">
            <button class="btn btn-primary" (click)="onUpdatePhone()">{{t('save')}}</button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (activeTab() === 'addresses') {
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body p-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
          <h3 class="card-title">{{t('yourAddresses')}}</h3>
          @if ((addresses() || []).length === 0) {
            <button class="btn btn-primary btn-sm" (click)="openAddAddress()">{{t('addAddress')}}</button>
          }
        </div>

        @if (isLoadingAddresses()) {
          <div class="flex justify-center py-8">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        } @else {
          @if ((addresses() || []).length === 0) {
            <div class="text-center text-base-content/60 py-6">{{t('noAddressesFound')}}</div>
          } @else {
            <!-- Desktop / tablet table view -->
            <div class="hidden md:block">
              <div class="overflow-x-auto">
                <table class="table table-zebra">
                  <thead>
                    <tr>
                      <th>{{t('name')}}</th>
                      <th>{{t('phone')}}</th>
                      <th>{{t('address')}}</th>
                      <th>{{t('cityState')}}</th>
                      <th>{{t('postal')}}</th>
                      <th>{{t('default')}}</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (addr of addresses(); track addr.id) {
                      <tr>
                        <td>{{addr.fullName}}</td>
                        <td>{{addr.phoneNumber}}</td>
                        <td>{{addr.addressLine1}} <span class="opacity-70" *ngIf="addr.addressLine2">, {{addr.addressLine2}}</span></td>
                        <td>{{addr.city}} <span *ngIf="addr.state">/ {{addr.state}}</span></td>
                        <td>{{addr.postalCode}}</td>
                        <td>
                          <div class="badge" [class.badge-success]="addr.isDefault" [class.badge-ghost]="!addr.isDefault">{{addr.isDefault ? t('yes') : t('no')}}</div>
                        </td>
                        <td class="text-right">
                          <div class="flex gap-2 justify-end">
                            <button class="btn btn-ghost btn-xs" (click)="openEditAddress(addr)">{{t('edit')}}</button>
                            <button class="btn btn-error btn-xs" (click)="deleteAddress(addr.id)">{{t('delete')}}</button>
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Mobile card view -->
            <div class="md:hidden space-y-3">
              @for (addr of addresses(); track addr.id) {
                <div class="border border-base-300 rounded-lg p-4 space-y-2">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="font-semibold">
                        {{addr.fullName}}
                      </div>
                      <div class="text-sm text-base-content/70">
                        {{addr.phoneNumber}}
                      </div>
                    </div>
                    <div class="shrink-0">
                      <div class="badge" [class.badge-success]="addr.isDefault" [class.badge-ghost]="!addr.isDefault">
                        {{addr.isDefault ? t('default') : t('secondary')}}
                      </div>
                    </div>
                  </div>

                  <div class="text-sm text-base-content">
                    <div>
                      {{addr.addressLine1}}
                      <span class="opacity-70" *ngIf="addr.addressLine2">, {{addr.addressLine2}}</span>
                    </div>
                    <div class="mt-1">
                      {{addr.city}}
                      <span *ngIf="addr.state">/ {{addr.state}}</span>
                      <span *ngIf="addr.postalCode">, {{addr.postalCode}}</span>
                    </div>
                    <div class="mt-1" *ngIf="addr.country">
                      {{addr.country}}
                    </div>
                  </div>

                  <div class="flex justify-end gap-2 pt-1">
                    <button class="btn btn-ghost btn-xs" (click)="openEditAddress(addr)">{{t('edit')}}</button>
                    <button class="btn btn-error btn-xs" (click)="deleteAddress(addr.id)">{{t('delete')}}</button>
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>

    <!-- Add Address Modal -->
    @if (showAddAddress()) {
      <div class="modal modal-open">
        <div class="modal-box max-w-3xl">
          <h3 class="font-bold text-lg mb-4">{{t('addAddress')}}</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('fullName')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.fullName" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('phone')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.phoneNumber" />
            </div>
            <div class="form-control md:col-span-2">
              <label class="label"><span class="label-text">{{t('addressLine1')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.addressLine1" />
            </div>
            <div class="form-control md:col-span-2">
              <label class="label"><span class="label-text">{{t('addressLine2')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.addressLine2" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('country')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.country" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('city')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.city" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('state')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.state" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('postalCode')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="newAddress.postalCode" />
            </div>
            <div class="form-control md:col-span-2">
              <label class="cursor-pointer label justify-start gap-3">
                <input type="checkbox" class="checkbox" [(ngModel)]="newAddress.isDefault">
                <span class="label-text">{{t('setAsDefault')}}</span>
              </label>
            </div>
          </div>
          <div class="modal-action">
            <button class="btn btn-ghost" (click)="showAddAddress.set(false)">{{t('cancel')}}</button>
            <button class="btn btn-primary" (click)="addAddress()">{{t('save')}}</button>
          </div>
        </div>
      </div>
    }

    <!-- Edit Address Modal -->
    @if (showEditAddress()) {
      <div class="modal modal-open">
        <div class="modal-box max-w-3xl">
          <h3 class="font-bold text-lg mb-4">{{t('editAddress')}}</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('fullName')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.fullName" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('phone')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.phoneNumber" />
            </div>
            <div class="form-control md:col-span-2">
              <label class="label"><span class="label-text">{{t('addressLine1')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.addressLine1" />
            </div>
            <div class="form-control md:col-span-2">
              <label class="label"><span class="label-text">{{t('addressLine2')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.addressLine2" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('country')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.country" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('city')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.city" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('state')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.state" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">{{t('postalCode')}}</span></label>
              <input class="input input-bordered" [(ngModel)]="editAddress.postalCode" />
            </div>
            <div class="form-control md:col-span-2">
              <label class="cursor-pointer label justify-start gap-3">
                <input type="checkbox" class="checkbox" [(ngModel)]="editAddress.isDefault">
                <span class="label-text">{{t('setAsDefault')}}</span>
              </label>
            </div>
          </div>
          <div class="modal-action">
            <button class="btn btn-ghost" (click)="showEditAddress.set(false)">{{t('cancel')}}</button>
            <button class="btn btn-primary" (click)="updateAddress()">{{t('save')}}</button>
          </div>
        </div>
      </div>
    }
  }

  <app-toast [toasts]="toastService.toasts$()" (close)="toastService.removeToast($event)"></app-toast>
</div>
